<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø­Ù…ÙˆØ¯ | Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø¬Ù…ÙŠÙ„ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <!-- Ù…ÙƒØªØ¨Ø© jsPDF Ù„ØªÙˆÙ„ÙŠØ¯ PDF ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          integrity="sha512-/8aAqjF7kDbDeihdj5Z8SGvtQvECOHc1HwNfTK8F1DYjwMYJN9WewtGaozvQNf1v9F9MaW1u5V7YxKp7rMTaBA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000000;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #000;
      border-bottom: 1px solid #18181b;
      padding: 16px;
      text-align: center;
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
    }

    header p {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .layout {
      flex: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .layout {
        grid-template-columns: 280px minmax(0, 1fr);
        align-items: stretch;
      }
    }

    @media (max-width: 899px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* ====== SIDEBAR ====== */

    .sidebar {
      background: #050505;
      border: 1px solid #27272f;
      border-radius: 18px;
      padding: 14px 12px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 100%;
    }

    .sidebar-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .sidebar-sub {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .tool-group-title {
      font-size: 12px;
      opacity: 0.8;
      margin: 10px 0 4px;
    }

    .tool-btn {
      width: 100%;
      text-align: right;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      font-size: 12px;
      cursor: pointer;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      transition: background 0.15s, transform 0.08s;
    }

    .tool-btn span {
      font-size: 10px;
      opacity: 0.8;
    }

    .tool-btn:hover {
      background: #111827;
      transform: translateY(-1px);
    }

    .tool-btn:active {
      transform: translateY(0);
    }

    .saved-list {
      margin-top: 6px;
      max-height: 180px;
      overflow-y: auto;
      border-top: 1px solid #18181b;
      padding-top: 6px;
    }

    .saved-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }

    .saved-title {
      font-size: 12px;
      opacity: 0.8;
    }

    .saved-title-row select {
      background: #020617;
      color: #e5e5e5;
      border-radius: 999px;
      border: 1px solid #27272f;
      font-size: 11px;
      padding: 2px 6px;
      outline: none;
    }

    .saved-item {
      width: 100%;
      text-align: right;
      padding: 6px 9px;
      margin-bottom: 4px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #d4d4d8;
      font-size: 11px;
      cursor: pointer;
      outline: none;
    }

    .saved-item-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .saved-item span.date {
      font-size: 10px;
      opacity: 0.7;
    }

    .saved-icon-btn {
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #0b0b11;
      color: #e5e5e5;
      cursor: pointer;
      margin-left: 4px;
    }

    .saved-empty {
      font-size: 11px;
      opacity: 0.6;
    }

    /* Pomodoro */

    .pomodoro {
      margin-top: 10px;
      border-top: 1px solid #18181b;
      padding-top: 8px;
    }

    .pomodoro-title {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 4px;
    }

    #pomodoroTime {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .pomodoro-buttons {
      display: flex;
      gap: 6px;
    }

    .pomodoro-buttons button {
      flex: 1;
      font-size: 11px;
      padding: 4px 0;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: pointer;
    }

    /* ====== CHAT AREA ====== */

    .chat-wrapper {
      background: #050505;
      border: 1px solid #27272f;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      min-height: 480px;
      overflow: hidden;
    }

    .chat-header {
      padding: 10px 14px;
      border-bottom: 1px solid #18181b;
      background: #000000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chat-header-title {
      font-weight: 600;
    }

    .chat-header-sub {
      font-size: 11px;
      opacity: 0.7;
    }

    .chat-header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
    }

    .mini-btn {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: pointer;
    }

    .mode-btn.active {
      background: #22c1c3;
      border-color: #22c1c3;
      color: #000;
    }

    .mini-select {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: pointer;
      outline: none;
    }

    .messages {
      flex: 1;
      padding: 14px;
      overflow-y: auto;
      background: radial-gradient(circle at 0 0, #050505, #000000);
      font-size: 14px;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 80%;
      line-height: 1.7;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg.ai {
      background: #18181b;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .msg.user {
      background: #2563eb;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .typing-indicator {
      font-size: 12px;
      opacity: 0.7;
      margin: 0 4px 4px;
      padding: 0 14px 4px;
      display: none;
    }

    .typing-indicator.visible {
      display: block;
    }

    .export-bar {
      padding: 6px 12px;
      border-top: 1px solid #18181b;
      border-bottom: 1px solid #18181b;
      background: #020617;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      flex-wrap: wrap;
    }

    .export-bar span {
      opacity: 0.8;
    }

    .export-btn {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: not-allowed;
      opacity: 0.4;
    }

    .export-btn.enabled {
      cursor: pointer;
      opacity: 1;
    }

    .input-area {
      padding: 10px;
      border-top: 1px solid #18181b;
      background: #000000;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-main {
      display: flex;
      flex: 1;
      gap: 8px;
      align-items: center;
    }

    .input-area input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #050505;
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    .input-area button.send-btn {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(120deg, #22c1c3, #4b6cff);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
    }

    .input-area .img-btn {
      font-size: 11px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: pointer;
      white-space: nowrap;
    }

    .image-hint {
      font-size: 11px;
      opacity: 0.7;
      flex-basis: 100%;
      margin-top: 4px;
    }

    footer {
      text-align: center;
      padding: 12px;
      font-size: 11px;
      opacity: 0.6;
      border-top: 1px solid #18181b;
    }

    /* ====== TOOL MODAL ====== */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: #050505;
      border-radius: 16px;
      border: 1px solid #27272f;
      max-width: 480px;
      width: 100%;
      padding: 14px 16px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .modal-desc {
      font-size: 11px;
      opacity: 0.75;
      margin-bottom: 8px;
    }

    .modal textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid #27272f;
      background: #020617;
      color: #ffffff;
      font-size: 13px;
      padding: 8px 10px;
      outline: none;
      margin-bottom: 8px;
      direction: rtl;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      font-size: 12px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #27272f;
      color: #e5e5e5;
    }

    .btn-primary {
      background: linear-gradient(120deg, #22c1c3, #4b6cff);
      color: #ffffff;
    }
  </style>
</head>
<body>

<header>
  <h1>Ù…Ø­Ù…ÙˆØ¯ â€“ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ</h1>
  <p>Ù…Ø³Ø§Ø¹Ø¯ Ø·Ø§Ù„Ø¨ Ø¹Ø±Ø¨ÙŠ: Ù†ÙˆØªØ§Øª + Ù…Ù‡Ø§Ù… + ÙˆÙ‚Øª + ØµØ­Ø© + PDF + ØµÙˆØ± + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ + Ø±ÙŠØ§Ø¶ÙŠØ§Øª</p>

  <div style="margin-top:8px; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;">
    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="userInfo" style="display:none; align-items:center; gap:8px;">
      <img id="userPhoto" src="" alt="user" style="width:26px; height:26px; border-radius:50%; border:1px solid #27272f; object-fit:cover;">
      <span id="userName" style="font-size:12px;"></span>
    </div>

    <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <button id="loginBtn"
            onclick="loginWithGoogle()"
            style="font-size:11px; padding:5px 10px; border-radius:999px; border:1px solid #27272f; background:#020617; color:#e5e5e5; cursor:pointer;">
      ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
    </button>

    <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
    <button id="logoutBtn"
            onclick="logoutFromGoogle()"
            style="display:none; font-size:11px; padding:5px 10px; border-radius:999px; border:1px solid #27272f; background:#020617; color:#e5e5e5; cursor:pointer;">
      ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    </button>
  </div>
</header>

<main class="layout">

  <!-- ===== SIDEBAR TOOLS ===== -->
  <aside class="sidebar">
    <div>
      <div class="sidebar-title">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</div>
      <div class="sidebar-sub">Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>

      <!-- Presets -->
      <div class="tool-group-title">Ø£ÙˆØ¶Ø§Ø¹ Ø¬Ø§Ù‡Ø²Ø© (Presets)</div>
      <button class="tool-btn" onclick="presetLectureImage()">
        Ù„Ø®Ù‘Øµ ØµÙˆØ±Ø© Ù…Ø­Ø§Ø¶Ø±Ø© <span>Lecture â†’ Note</span>
      </button>
      <button class="tool-btn" onclick="presetExamNote()">
        Ø¬Ù‡Ù‘Ø²Ù„ÙŠ Ù†ÙˆØªØ© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù† <span>Q&A Note</span>
      </button>
      <button class="tool-btn" onclick="downloadConversationPdf()">
        Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù…Ù„Ù PDF <span>Export chat</span>
      </button>

      <div class="tool-group-title">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†ÙˆØªØ© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©</div>
      <button class="tool-btn" onclick="openToolModal('summary')">
        ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†ÙˆØªØ© <span>Summarize</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('improve')">
        ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø© <span>Improve</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('new_text')">
        ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø¬Ø¯ÙŠØ¯ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ <span>Generate</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('autocomplete')">
        Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ <span>Continue</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('note_full')">
        Ø¥Ù†Ø´Ø§Ø¡ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© <span>Full note</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('bullet_to_para')">
        ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· â†’ ÙÙ‚Ø±Ø© <span>Bullets â†’ Paragraph</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('ask_about_note')">
        Ø³Ø¤Ø§Ù„ AI Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ÙˆØªØ© <span>Ask note</span>
      </button>

      <div class="tool-group-title">Ù‚ÙˆØ§Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø·Ù„Ø§Ø¨</div>
      <button class="tool-btn" onclick="templateSubjectSummary()">
        Ù‚Ø§Ù„Ø¨ Ù…Ù„Ø®Øµ Ù…Ø§Ø¯Ø© <span>Subject summary</span>
      </button>
      <button class="tool-btn" onclick="templateExamPlan()">
        Ø®Ø·Ø© Ø¯Ø±Ø§Ø³Ø© Ù„Ø§Ù…ØªØ­Ø§Ù† Ø£Ø³Ø¨ÙˆØ¹ <span>Exam plan</span>
      </button>
      <button class="tool-btn" onclick="templateBookSummary()">
        ØªÙ„Ø®ÙŠØµ ÙƒØªØ§Ø¨ / Ø¨Ø§Ø¨ ÙƒØ§Ù…Ù„ <span>Book / chapter</span>
      </button>

      <div class="tool-group-title" style="margin-top: 12px;">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</div>
      <button class="tool-btn" onclick="openToolModal('planner')">
        Planner AI Ù„Ù„Ù…Ù‡Ø§Ù… <span>Tasks plan</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('health')">
        Health AI Ù„Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ <span>Health</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('pomodoro_tool')">
        Pomodoro AI Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª <span>Focus text</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('pdf')">
        ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù PDF Ø¨Ø§Ù„Ù†Øµ <span>PDF text</span>
      </button>
    </div>

    <!-- Saved conversations -->
    <div class="saved-list">
      <div class="saved-title-row">
        <span class="saved-title">Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© (Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²)</span>
        <select id="savedFilter" onchange="changeFilter(this.value)">
          <option value="all">Ø§Ù„ÙƒÙ„</option>
          <option value="notes">Ù†ÙˆØªØ§Øª</option>
          <option value="plans">Ø®Ø·Ø·</option>
          <option value="images">ØµÙˆØ±</option>
        </select>
      </div>
      <div id="savedConversations"></div>
    </div>

    <!-- Pomodoro Timer -->
    <div class="pomodoro">
      <div class="pomodoro-title">Ù…Ø¤Ù‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ² (Pomodoro)</div>
      <div id="pomodoroTime">25:00</div>
      <div class="pomodoro-buttons">
        <button onclick="startPomodoro()">Ø¨Ø¯Ø¡</button>
        <button onclick="pausePomodoro()">Ø¥ÙŠÙ‚Ø§Ù</button>
        <button onclick="resetPomodoro()">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </div>
  </aside>

  <!-- ===== CHAT ===== -->
  <section class="chat-wrapper">
    <div class="chat-header">
      <div>
        <div class="chat-header-title">Ø´Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
        <div class="chat-header-sub">Ø¬Ø§Ù‡Ø² Ù†Ø®Ù„ÙŠ Ø´ØºÙ„Ùƒ Ø£Ø³Ù‡Ù„ Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ˜</div>
      </div>
      <div class="chat-header-actions">
        <button class="mini-btn" onclick="saveCurrentConversation()">Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        <button class="mini-btn" onclick="clearConversation()">Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>

        <div>
          <button id="modeTurbo" class="mini-btn mode-btn active" onclick="setMode('turbo')">Turbo</button>
          <button id="modeDeep" class="mini-btn mode-btn" onclick="setMode('deep')">Ø¯Ù‚ÙŠÙ‚</button>
        </div>

        <div>
          <select id="profileSelect" class="mini-select" onchange="setProfile(this.value)">
            <option value="uni">Ø·Ø§Ù„Ø¨ Ø¬Ø§Ù…Ø¹Ø© ğŸ“</option>
            <option value="school">Ø·Ø§Ù„Ø¨ Ù…Ø¯Ø±Ø³Ø© ğŸ“˜</option>
            <option value="it">Ù…Ø¨Ø±Ù…Ø¬ / IT ğŸ’»</option>
            <option value="work">Ù…ÙˆØ¸Ù / Ø¥Ù†ØªØ§Ø¬ÙŠØ© ğŸ—‚ï¸</option>
            <option value="english">Ù…Ø³Ø§Ø¹Ø¯ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ğŸ‡¬ğŸ‡§</option>
            <option value="math">Ù…Ø³Ø§Ø¹Ø¯ Ø±ÙŠØ§Ø¶ÙŠØ§Øª â—</option>
          </select>
        </div>
      </div>
    </div>

    <div id="messages" class="messages"></div>

    <div id="typingIndicator" class="typing-indicator">
      Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙÙƒØ± ÙÙŠ Ø§Ù„Ø±Ø¯...
    </div>

    <div class="export-bar">
      <span>ØªØµØ¯ÙŠØ± Ø¢Ø®Ø± Ø±Ø¯:</span>
      <button id="btnTxt" class="export-btn" onclick="downloadAsTxt()" disabled>TXT</button>
      <button id="btnDoc" class="export-btn" onclick="downloadAsDoc()" disabled>Word</button>
      <button id="btnPdf" class="export-btn" onclick="downloadAsPdf()" disabled>PDF</button>
      <button id="btnTodo" class="export-btn" onclick="convertReplyToTodo()" disabled>To-Do</button>
    </div>

    <div class="input-area">
      <div class="input-main">
        <input id="chatInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." />
        <button id="sendBtn" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
      <button class="img-btn" onclick="triggerImagePicker()">ğŸ“· Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©</button>
      <input id="imageInput" type="file" accept="image/*" style="display:none" />
      <div class="image-hint" id="imageHint"></div>
    </div>
  </section>

</main>

<footer>
  Â© <span id="year"></span> Ù…Ø­Ù…ÙˆØ¯ â€“ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
</footer>

<!-- ===== TOOL MODAL ===== -->
<div id="toolModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-title" id="toolModalTitle">Ø£Ø¯Ø§Ø©</div>
    <div class="modal-desc" id="toolModalDesc"></div>
    <textarea id="toolModalTextarea" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ù‡Ù†Ø§..."></textarea>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeToolModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="sendToolRequest()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø©</button>
    </div>
  </div>
</div>

<script>
  // ===== Firebase Config & Init =====
  // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆÙ†ÙÙŠØº Ù…Ù† Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAqW7jLuYCig9M-R-0by1bMLoUZYs55VtQ",
    authDomain: "mahmoud-ai-ce938.firebaseapp.com",
    projectId: "mahmoud-ai-ce938",
    storageBucket: "mahmoud-ai-ce938.firebasestorage.app",
    messagingSenderId: "705709424722",
    appId: "1:705709424722:web:8811208d6023235dac9f8b",
    measurementId: "G-WMV1DF9VB5"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  let currentUser = null;

  function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then((result) => {
        console.log("Logged in:", result.user);
      })
      .catch((error) => {
        console.error("Login error:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
      });
  }

  function logoutFromGoogle() {
    auth.signOut()
      .then(() => {
        console.log("Logged out");
      })
      .catch((error) => {
        console.error("Logout error:", error);
      });
  }

  auth.onAuthStateChanged((user) => {
    currentUser = user;
    const loginBtn  = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo  = document.getElementById("userInfo");
    const userName  = document.getElementById("userName");
    const userPhoto = document.getElementById("userPhoto");

    if (user) {
      loginBtn.style.display  = "none";
      logoutBtn.style.display = "inline-block";
      userInfo.style.display  = "flex";

      userName.textContent = "Ø£Ù‡Ù„Ø§Ù‹ØŒ " + (user.displayName || "Ù…Ø³ØªØ®Ø¯Ù…");
      if (user.photoURL) {
        userPhoto.src = user.photoURL;
      }
    } else {
      loginBtn.style.display  = "inline-block";
      logoutBtn.style.display = "none";
      userInfo.style.display  = "none";
      userName.textContent    = "";
      userPhoto.src           = "";
    }
  });

  // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =====
  const API_CHAT  = "https://atlas-ai-hrgs.onrender.com/api/chat";
  const API_IMAGE = "https://atlas-ai-hrgs.onrender.com/api/image_chat";

  const messagesEl  = document.getElementById("messages");
  const inputEl     = document.getElementById("chatInput");
  const sendBtn     = document.getElementById("sendBtn");
  const typingEl    = document.getElementById("typingIndicator");
  const imageInput  = document.getElementById("imageInput");
  const imageHint   = document.getElementById("imageHint");
  const savedListEl = document.getElementById("savedConversations");

  document.getElementById("year").textContent = new Date().getFullYear();

  let lastAiReply          = "";
  let currentConversation  = [];
  let savedConversations   = [];
  let currentFilter        = "all";
  let currentMode          = "turbo";
  let currentProfile       = "uni";
  let imagePresetPrompt    = "";

  // Pomodoro
  let pomodoroDuration  = 25 * 60;
  let pomodoroRemaining = pomodoroDuration;
  let pomodoroTimer     = null;

  function updatePomodoroDisplay() {
    const m = Math.floor(pomodoroRemaining / 60).toString().padStart(2,"0");
    const s = (pomodoroRemaining % 60).toString().padStart(2,"0");
    document.getElementById("pomodoroTime").textContent = `${m}:${s}`;
  }

  function startPomodoro() {
    if (pomodoroTimer) return;
    pomodoroTimer = setInterval(() => {
      if (pomodoroRemaining > 0) {
        pomodoroRemaining--;
        updatePomodoroDisplay();
      } else {
        clearInterval(pomodoroTimer);
        pomodoroTimer = null;
        alert("Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²! Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø© Ù‚ØµÙŠØ±Ø© â˜•");
      }
    }, 1000);
  }

  function pausePomodoro() {
    if (pomodoroTimer) {
      clearInterval(pomodoroTimer);
      pomodoroTimer = null;
    }
  }

  function resetPomodoro() {
    pausePomodoro();
    pomodoroRemaining = pomodoroDuration;
    updatePomodoroDisplay();
  }

  updatePomodoroDisplay();

  // ===== Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø§Øª =====
  function addMessage(text, sender, addToMemory = true) {
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    if (addToMemory) {
      currentConversation.push({
        sender,
        text,
        ts: Date.now(),
      });
    }

    if (sender === "ai") {
      lastAiReply = text;
      updateExportButtons();
    }
  }

  function showTyping() {
    typingEl.classList.add("visible");
  }

  function hideTyping() {
    typingEl.classList.remove("visible");
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    addMessage(text, "user");
    inputEl.value = "";
    await callTextApi(text);
  }

  async function callTextApi(messageText) {
    try {
      showTyping();

      const res = await fetch(API_CHAT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: messageText,
          mode: currentMode,
          profile: currentProfile,
        }),
      });

      const data = await res.json();
      hideTyping();

      if (data.reply) {
        addMessage(data.reply, "ai");
      } else if (data.text) {
        addMessage(data.text, "ai");
      } else {
        addMessage("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯ Ù„ÙƒÙ† ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡ØªÙ‡.", "ai");
      }
    } catch (err) {
      console.error(err);
      hideTyping();
      addMessage("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.", "ai");
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø£ÙˆÙ„ Ù…Ø±Ø©
  addMessage(
    "Ø£Ù‡Ù„Ø§Ù‹ Ù…Ø­Ù…ÙˆØ¯ ğŸ‘‹\nØ¬Ø§Ù‡Ø² Ù†Ø®Ù„ÙŠ Ø´ØºÙ„Ùƒ Ø£Ø³Ù‡Ù„ Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ˜\n" +
    "Ø§Ø®ØªØ± Ù†ÙˆØ¹Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø·Ø§Ù„Ø¨ Ø¬Ø§Ù…Ø¹Ø©ØŒ Ù…Ø¯Ø±Ø³Ø©ØŒ Ù…Ø¨Ø±Ù…Ø¬ØŒ Ù…ÙˆØ¸ÙØŒ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØŒ Ø±ÙŠØ§Ø¶ÙŠØ§Øª) Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©.",
    "ai",
    true
  );

  // ===== Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª (localStorage ÙÙ‚Ø·) =====
  function loadSavedConversations() {
    try {
      const raw = localStorage.getItem("mahmoud_ai_conversations") || "[]";
      savedConversations = JSON.parse(raw);
    } catch {
      savedConversations = [];
    }
    renderSavedConversations();
  }

  function guessConversationCategory(convMessages) {
    const all = convMessages.map((m) => m.text).join(" ").toLowerCase();
    if (all.includes("ğŸ”") || all.includes("ØµÙˆØ±Ø©") || all.includes("image")) return "images";
    if (all.includes("planner ai") || all.includes("Ø®Ø·Ø© Ø¯Ø±Ø§Ø³Ø©") || all.includes("pomodoro")) return "plans";
    return "notes";
  }

  function renderSavedConversations() {
    savedListEl.innerHTML = "";
    const filtered = savedConversations.filter((c) =>
      currentFilter === "all" ? true : c.category === currentFilter
    );

    if (!filtered.length) {
      const span = document.createElement("span");
      span.className = "saved-empty";
      span.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.";
      savedListEl.appendChild(span);
      return;
    }

    filtered
      .slice()
      .reverse()
      .forEach((conv) => {
        const btn = document.createElement("div");
        btn.className = "saved-item";
        btn.onclick = () => loadConversation(conv.id);

        const title = conv.title || "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const date  = new Date(conv.createdAt).toLocaleString("ar-JO");

        btn.innerHTML = `
          <div class="saved-item-main">
            <div>${title}</div>
            <div>
              <button class="saved-icon-btn" onclick="renameConversation(${conv.id}, event)">âœï¸</button>
              <button class="saved-icon-btn" onclick="deleteConversation(${conv.id}, event)">ğŸ—‘</button>
            </div>
          </div>
          <span class="date">${date}</span>
        `;

        savedListEl.appendChild(btn);
      });
  }

  function saveCurrentConversation() {
    if (!currentConversation.length) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ø­ÙØ¸Ù‡.");
      return;
    }

    const firstUserMsg = currentConversation.find((m) => m.sender === "user");
    const title = firstUserMsg ? firstUserMsg.text.slice(0, 24) + "..." : "Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­ÙÙˆØ¸Ø©";

    const category = guessConversationCategory(currentConversation);

    const conv = {
      id: Date.now(),
      title,
      createdAt: Date.now(),
      category,
      messages: currentConversation,
    };

    savedConversations.push(conv);
    localStorage.setItem("mahmoud_ai_conversations", JSON.stringify(savedConversations));
    renderSavedConversations();
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²).");
  }

  function loadConversation(id) {
    const conv = savedConversations.find((c) => c.id === id);
    if (!conv) return;

    messagesEl.innerHTML  = "";
    currentConversation   = conv.messages.slice();
    lastAiReply           = "";
    currentConversation.forEach((m) => {
      addMessage(m.text, m.sender, false);
      if (m.sender === "ai") {
        lastAiReply = m.text;
      }
    });
    updateExportButtons();
  }

  function clearConversation() {
    messagesEl.innerHTML = "";
    currentConversation  = [];
    lastAiReply          = "";
    addMessage(
      "Ø¨Ø¯Ø£Ù†Ø§ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© âœ…\n" +
      "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆÙ„Ø§ ØªÙ†Ø³Ù Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹Ùƒ Ù…Ù† ÙÙˆÙ‚ (Ø¬Ø§Ù…Ø¹Ø©/Ù…Ø¯Ø±Ø³Ø©/Ù…Ø¨Ø±Ù…Ø¬/Ù…ÙˆØ¸Ù/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ/Ø±ÙŠØ§Ø¶ÙŠØ§Øª).",
      "ai",
      true
    );
    updateExportButtons();
  }

  function renameConversation(id, ev) {
    ev.stopPropagation();
    const conv = savedConversations.find((c) => c.id === id);
    if (!conv) return;
    const newTitle = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:", conv.title || "");
    if (!newTitle) return;
    conv.title = newTitle;
    localStorage.setItem("mahmoud_ai_conversations", JSON.stringify(savedConversations));
    renderSavedConversations();
  }

  function deleteConversation(id, ev) {
    ev.stopPropagation();
    if (!confirm("Ù…ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù Ù‡Ø§ÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) return;
    savedConversations = savedConversations.filter((c) => c.id !== id);
    localStorage.setItem("mahmoud_ai_conversations", JSON.stringify(savedConversations));
    renderSavedConversations();
  }

  function changeFilter(val) {
    currentFilter = val;
    renderSavedConversations();
  }

  loadSavedConversations();
  updateExportButtons();

  // ===== Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ø±Ø¯ (Turbo / Ø¯Ù‚ÙŠÙ‚) =====
  function setMode(mode) {
    currentMode = mode;
    document.getElementById("modeTurbo").classList.toggle("active", mode === "turbo");
    document.getElementById("modeDeep").classList.toggle("active", mode === "deep");
  }

  // ===== Profiles =====
  function setProfile(profile) {
    currentProfile = profile;
    localStorage.setItem("mahmoud_ai_profile", profile);
  }

  (function initProfile() {
    const savedProf = localStorage.getItem("mahmoud_ai_profile");
    if (savedProf) {
      currentProfile = savedProf;
      const sel = document.getElementById("profileSelect");
      if (sel) sel.value = savedProf;
    }
  })();

  // ===== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†ÙˆØªØ© (Sidebar Tools) =====
  let currentTool = null;

  const TOOL_CONFIG = {
    summary: {
      title: "ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†ÙˆØªØ©",
      desc: "Ø£Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªÙ„Ø®ÙŠØµÙ‡ØŒ ÙˆØ³Ø£Ù‚Ø¯Ù‘Ù… Ù„Ùƒ Ù…Ù„Ø®ØµØ§Ù‹ Ù…Ù†Ø¸Ù‘Ù…Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹.",
    },
    improve: {
      title: "ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©",
      desc: "Ø£Ù„ØµÙ‚ Ø§Ù„Ù†ØµØŒ ÙˆØ³Ø£Ø¹ÙŠØ¯ ØµÙŠØ§ØºØªÙ‡ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ØŒ Ø£ÙˆØ¶Ø­ØŒ ÙˆØ£Ù‚ÙˆÙ‰ Ù„ØºÙˆÙŠØ§Ù‹.",
    },
    new_text: {
      title: "ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø¬Ø¯ÙŠØ¯",
      desc: "Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ (Ù…Ø«Ù„Ø§Ù‹: Ù…Ù‚Ø§Ù„ØŒ Ø±Ø³Ø§Ù„Ø©ØŒ ÙˆØµÙØŒ Ù…Ù†Ø´ÙˆØ±...) ÙˆØ³Ø£ÙƒØªØ¨ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹.",
    },
    autocomplete: {
      title: "Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹",
      desc: "Ø£Ù„ØµÙ‚ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†ØµØŒ ÙˆØ³Ø£ÙƒÙ…Ù„ Ø¹Ù„ÙŠÙƒ Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨.",
    },
    note_full: {
      title: "Ø¥Ù†Ø´Ø§Ø¡ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø©",
      desc: "Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ ÙˆØ³Ø£Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©.",
    },
    bullet_to_para: {
      title: "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø©",
      desc: "Ø£Ù„ØµÙ‚ Ù†Ù‚Ø§Ø·Ùƒ (ÙƒÙ„ Ù†Ù‚Ø·Ø© ÙÙŠ Ø³Ø·Ø±)ØŒ ÙˆØ³Ø£Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø© Ù…ØªØ±Ø§Ø¨Ø·Ø©.",
    },
    ask_about_note: {
      title: "Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ÙˆØªØ©",
      desc: "Ø£Ù„ØµÙ‚ Ø§Ù„Ù†ÙˆØªØ©ØŒ Ø«Ù… Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù†Ù‡Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ù‚Ù„.",
    },
    planner: {
      title: "Planner AI Ù„Ù„Ù…Ù‡Ø§Ù…",
      desc: "Ø§ÙƒØªØ¨ Ù…Ù‡Ø§Ù…Ùƒ Ø£Ùˆ Ø£Ù‡Ø¯Ø§ÙÙƒ Ù„Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŒ ÙˆØ³Ø£Ø±ØªØ¨Ù‡Ø§ Ù„Ùƒ Ø¨Ø®Ø·Ø© Ù…Ù†Ø¸Ù…Ø©.",
    },
    health: {
      title: "Health AI Ù„Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ",
      desc: "Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ù†Ù…Ø· Ø­ÙŠØ§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙˆØ³Ø£Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ Ø±ÙˆØªÙŠÙ†Ø§Ù‹ ØµØ­ÙŠØ§Ù‹ Ø¨Ø³ÙŠØ·Ø§Ù‹.",
    },
    pomodoro_tool: {
      title: "Pomodoro AI",
      desc: "Ø§ÙƒØªØ¨ Ù…Ø§ ØªØ±ÙŠØ¯ Ø¥Ù†Ø¬Ø§Ø²Ù‡ØŒ ÙˆØ³Ø£Ù‚Ø³Ù‘Ù…Ù‡ Ù„Ùƒ Ø¥Ù„Ù‰ Ø¬Ù„Ø³Ø§Øª ØªØ±ÙƒÙŠØ² Ø¨Ù†Ø¸Ø§Ù… Pomodoro.",
    },
    pdf: {
      title: "ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù PDF Ø¨Ø§Ù„Ù†Øµ",
      desc: "Ø§Ù†Ø³Ø® Ù†ØµØ§Ù‹ Ù…Ù† Ù…Ù„Ù PDF Ø£Ùˆ ÙˆØµÙ Ù…Ø­ØªÙˆØ§Ù‡ØŒ ÙˆØ³Ø£Ø­Ù„Ù‘Ù„Ù‡ Ù„Ùƒ ÙˆØ£Ø³ØªØ®Ø±Ø¬ Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø·.",
    },
  };

  const modalBackdrop  = document.getElementById("toolModalBackdrop");
  const modalTitle     = document.getElementById("toolModalTitle");
  const modalDesc      = document.getElementById("toolModalDesc");
  const modalTextarea  = document.getElementById("toolModalTextarea");

  function openToolModal(toolKey) {
    currentTool = toolKey;
    const cfg   = TOOL_CONFIG[toolKey];
    modalTitle.textContent   = cfg.title;
    modalDesc.textContent    = cfg.desc;
    modalTextarea.value      = "";
    modalBackdrop.classList.add("visible");
  }

  function closeToolModal() {
    modalBackdrop.classList.remove("visible");
    currentTool = null;
  }

  function buildToolPrompt(toolKey, text) {
    switch (toolKey) {
      case "summary":
        return `Ø£Ù„Ø®Ù‘Øµ Ù„Ùƒ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù… Ø¨Ù†Ù‚Ø§Ø· ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©:\n\n${text}`;
      case "improve":
        return `Ø­Ø³Ù‘Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù†Ù‰:\n\n${text}`;
      case "new_text":
        return `Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹ ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨:\n\n${text}`;
      case "autocomplete":
        return `Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ø´Ø§Ø¨Ù‡ ÙˆØ·Ø¨ÙŠØ¹ÙŠ:\n\n${text}`;
      case "note_full":
        return `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø© ÙˆÙ…Ù‚Ø³Ù…Ø© Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©:\n\n${text}`;
      case "bullet_to_para":
        return `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ§Ù„ÙŠØ© (ÙƒÙ„ Ø³Ø·Ø± Ù†Ù‚Ø·Ø©) Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…ØªØ±Ø§Ø¨Ø·Ø©:\n\n${text}`;
      case "ask_about_note":
        return `Ø³Ø£Ø¹Ø·ÙŠÙƒ Ù†ÙˆØªØ© ÙˆØ³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù†Ù‡Ø§. Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ù†ÙˆØªØ©ØŒ Ø«Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…ØªÙŠ [Ø³Ø¤Ø§Ù„].\n\n${text}`;
      case "planner":
        return `Ø£Ù†Øª Planner AI Ù„Ù…Ø­Ù…ÙˆØ¯. Ø£Ù†Ø´Ø¦ Ø®Ø·Ø© Ù…Ù‡Ø§Ù… Ù…Ù†Ø¸Ù…Ø© Ø§Ø³ØªÙ†Ø§Ø¯Ø§Ù‹ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª:\n\n${text}`;
      case "health":
        return `Ø£Ù†Øª Health AI Ù„Ù…Ø­Ù…ÙˆØ¯. Ø§Ù‚ØªØ±Ø­ Ø±ÙˆØªÙŠÙ†Ø§Ù‹ ØµØ­ÙŠØ§Ù‹ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ø¨Ø³Ø·Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n\n${text}`;
      case "pomodoro_tool":
        return `Ù‚Ø³Ù‘Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ø¥Ù„Ù‰ Ø¬Ù„Ø³Ø§Øª ØªØ±ÙƒÙŠØ² Ø¨Ù†Ø¸Ø§Ù… Pomodoro (25 Ø¯Ù‚ÙŠÙ‚Ø© ØªØ±ÙƒÙŠØ² + 5 Ø±Ø§Ø­Ø©):\n\n${text}`;
      case "pdf":
        return `Ù‡Ø°Ø§ Ù†Øµ Ù…Ø£Ø®ÙˆØ° Ù…Ù† Ù…Ù„Ù PDF Ø£Ùˆ ÙˆØµÙ Ù…Ø­ØªÙˆØ§Ù‡. Ø­Ù„Ù‘Ù„Ù‡ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø£Ù‡Ù… Ø§Ù„Ø£ÙÙƒØ§Ø± Ù…Ø¹ Ù…Ù„Ø®Øµ:\n\n${text}`;
      default:
        return text;
    }
  }

  async function sendToolRequest() {
    const rawText = modalTextarea.value.trim();
    if (!currentTool || !rawText) return;

    const cfg        = TOOL_CONFIG[currentTool];
    const toolPrompt = buildToolPrompt(currentTool, rawText);

    addMessage(`[${cfg.title}]\n${rawText}`, "user");
    closeToolModal();

    await callTextApi(toolPrompt);
  }

  // ===== Presets Ùˆ Templates =====
  function presetLectureImage() {
    imagePresetPrompt = "Ù„Ø®Ù‘Øµ Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ£Ù†Ù‡Ø§ Ø³Ù„Ø§ÙŠØ¯Ø§Øª Ù…Ø­Ø§Ø¶Ø±Ø©ØŒ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø£Ù‡Ù… Ø§Ù„Ø£ÙÙƒØ§Ø± ÙÙŠ Ø´ÙƒÙ„ Ù†ÙˆØªØ© Ù…Ù†Ø¸Ù…Ø© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†.";
    triggerImagePicker();
  }

  function presetExamNote() {
    inputEl.value = "Ø¹Ù†Ø¯ÙŠ Ù†ÙˆØªØ© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†. Ù„Ø®ØµÙ‡Ø§ Ù„ÙŠØŒ Ø«Ù… Ø¬Ù‡Ù‘Ø² Ø£Ø³Ø¦Ù„Ø© ÙˆØ£Ø¬ÙˆØ¨Ø© Ø¹Ù„ÙŠÙ‡Ø§ (Ø³Ø¤Ø§Ù„ ÙˆØ¬ÙˆØ§Ø¨) Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ³Ø§Ø¹Ø¯Ù†ÙŠ Ø£Ø±Ø§Ø¬Ø¹ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.";
    inputEl.focus();
  }

  function templateSubjectSummary() {
    inputEl.value =
      "Ø£Ø±ÙŠØ¯ Ù…Ù†Ùƒ Ø£Ù† ØªØµÙ†Ø¹ Ù„ÙŠ Ù…Ù„Ø®Øµ Ù…Ø§Ø¯Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:\n" +
      "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:\n" +
      "Ø§Ù„Ø¯ÙƒØªÙˆØ±:\n" +
      "Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:\n" +
      "Ø§Ù„Ù†Øµ / Ø§Ù„Ù†ÙˆØªØ©:\n\n" +
      "Ø±Ø¬Ø§Ø¡Ù‹ Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©ØŒ ÙˆÙ†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ ÙˆØ£Ù…Ø«Ù„Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª.";
    inputEl.focus();
  }

  function templateExamPlan() {
    inputEl.value =
      "Ø£Ø±ÙŠØ¯ Ø®Ø·Ø© Ø¯Ø±Ø§Ø³Ø© Ù„Ø§Ù…ØªØ­Ø§Ù† Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯:\n" +
      "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:\n" +
      "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:\n" +
      "Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©:\n" +
      "Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹:\n\n" +
      "Ù‚Ø³Ù‘Ù… Ù„ÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø±ÙŠØ­Ø©ØŒ ÙˆØ­Ø¯Ø¯ Ù…Ø§Ø°Ø§ Ø£Ø¯Ø±Ø³ ÙƒÙ„ ÙŠÙˆÙ….";
    inputEl.focus();
  }

  function templateBookSummary() {
    inputEl.value =
      "Ø£Ø±ÙŠØ¯ ØªÙ„Ø®ÙŠØµ ÙƒØªØ§Ø¨ / Ø¨Ø§Ø¨ ÙƒØ§Ù…Ù„:\n" +
      "Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø¨:\n" +
      "Ø§Ù„Ù…Ø¤Ù„Ù (Ø¥Ù† ÙˆØ¬Ø¯):\n" +
      "Ø§Ù„Ù†Øµ / Ø§Ù„Ù†ÙˆØªØ© Ø£Ùˆ Ø£Ù‡Ù… Ø§Ù„ÙÙ‚Ø±Ø§Øª:\n\n" +
      "Ø±Ø¬Ø§Ø¡Ù‹ Ù„Ø®ØµÙ‡ Ù„ÙŠ Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©ØŒ ÙˆÙ†Ù‚Ø§Ø· Ù…Ù‡Ù…Ø©ØŒ ÙˆÙƒØ£Ù†Ù‡Ø§ Ù†ÙˆØªØ© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.";
    inputEl.focus();
  }

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± =====
  function triggerImagePicker() {
    imageInput.click();
  }

  imageInput.addEventListener("change", async () => {
    const file = imageInput.files[0];
    if (!file) return;

    imageHint.textContent = "ğŸ“· ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©ØŒ ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø±ÙØ¹Ù‡Ø§ ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§...";
    const reader = new FileReader();
    reader.onload = async () => {
      const base64Data = reader.result.split(",")[1];

      const text = inputEl.value.trim();
      inputEl.value = "";

      const usedPrompt = imagePresetPrompt || text;
      imagePresetPrompt = "";

      addMessage(
        usedPrompt
          ? `ğŸ” ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:\n${usedPrompt}`
          : "ğŸ” Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„...",
        "user"
      );

      await callImageApi(base64Data, usedPrompt);
      imageHint.textContent = "";
      imageInput.value      = "";
    };
    reader.readAsDataURL(file);
  });

  async function callImageApi(imageBase64, messageText) {
    try {
      showTyping();

      const res = await fetch(API_IMAGE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: messageText || "",
          image: imageBase64,
          mode: currentMode,
          profile: currentProfile,
        }),
      });

      const data = await res.json();
      hideTyping();

      if (data.reply) {
        addMessage(data.reply, "ai");
      } else if (data.text) {
        addMessage(data.text, "ai");
      } else {
        addMessage("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯ Ù„ÙƒÙ† ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡ØªÙ‡.", "ai");
      }
    } catch (err) {
      console.error(err);
      hideTyping();
      addMessage("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.", "ai");
    }
  }

  // ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± (Ø¢Ø®Ø± Ø±Ø¯) =====
  function updateExportButtons() {
    const has = !!(lastAiReply && lastAiReply.trim());
    ["btnTxt", "btnDoc", "btnPdf", "btnTodo"].forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (has) {
        el.disabled = false;
        el.classList.add("enabled");
      } else {
        el.disabled = true;
        el.classList.remove("enabled");
      }
    });
  }

  function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href     = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function downloadAsTxt() {
    if (!lastAiReply || !lastAiReply.trim()) return;
    downloadFile("mahmoud_ai_note.txt", lastAiReply, "text/plain;charset=utf-8");
  }

  function downloadAsDoc() {
    if (!lastAiReply || !lastAiReply.trim()) return;
    const rtf = "{\\rtf1\\ansi\n" + lastAiReply.replace(/\n/g, "\\par\n") + "\n}";
    downloadFile("mahmoud_ai_note.doc", rtf, "application/rtf");
  }

  function downloadAsPdf() {
    if (!lastAiReply || !lastAiReply.trim()) return;
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("Ù…ÙƒØªØ¨Ø© PDF ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc       = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });

    const margin    = 40;
    const pageWidth = doc.internal.pageSize.getWidth();
    const maxWidth  = pageWidth - margin * 2;

    const lines = doc.splitTextToSize(lastAiReply, maxWidth);
    doc.text(lines, margin, margin);
    doc.save("mahmoud_ai_note.pdf");
  }

  async function convertReplyToTodo() {
    if (!lastAiReply || !lastAiReply.trim()) return;
    const prompt = `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… (To-Do list) Ø¨Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø©ØŒ Ù…Ø¹ ØªÙ‚Ø³ÙŠÙ… Ù…Ù†Ø·Ù‚ÙŠ:\n\n${lastAiReply}`;
    addMessage("Ø­ÙˆÙ‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù…:\n" + lastAiReply, "user");
    await callTextApi(prompt);
  }

  function downloadConversationPdf() {
    if (!currentConversation.length) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
      return;
    }
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("Ù…ÙƒØªØ¨Ø© PDF ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc       = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });

    const margin    = 40;
    const pageWidth = doc.internal.pageSize.getWidth();
    const maxWidth  = pageWidth - margin * 2;

    const lines = [];
    currentConversation.forEach((m) => {
      const prefix = m.sender === "user" ? "Ù…Ø­Ù…ÙˆØ¯: " : "Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯: ";
      const chunk  = prefix + m.text;
      const wrapped = doc.splitTextToSize(chunk, maxWidth);
      lines.push(...wrapped, "");
    });

    doc.text(lines, margin, margin);
    doc.save("mahmoud_ai_chat.pdf");
  }
</script>

</body>
</html>
