<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø­Ù…ÙˆØ¯ | Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø¬Ù…ÙŠÙ„ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Ù…ÙƒØªØ¨Ø© jsPDF Ù„ØªÙˆÙ„ÙŠØ¯ PDF ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          integrity="sha512-/8aAqjF7kDbDeihdj5Z8SGvtQvECOHc1HwNfTK8F1DYjwMYJN9WewtGaozvQNf1v9F9MaW1u5V7YxKp7rMTaBA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000000;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #000;
      border-bottom: 1px solid #18181b;
      padding: 16px;
      text-align: center;
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
    }

    header p {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .layout {
      flex: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .layout {
        grid-template-columns: 280px minmax(0, 1fr);
        align-items: stretch;
      }
    }

    @media (max-width: 899px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* ====== SIDEBAR ====== */

    .sidebar {
      background: #050505;
      border: 1px solid #27272f;
      border-radius: 18px;
      padding: 14px 12px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 100%;
    }

    .sidebar-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .sidebar-sub {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .tool-group-title {
      font-size: 12px;
      opacity: 0.8;
      margin: 10px 0 4px;
    }

    .tool-btn {
      width: 100%;
      text-align: right;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      font-size: 12px;
      cursor: pointer;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      transition: background 0.15s, transform 0.08s;
    }

    .tool-btn span {
      font-size: 10px;
      opacity: 0.8;
    }

    .tool-btn:hover {
      background: #111827;
      transform: translateY(-1px);
    }

    .tool-btn:active {
      transform: translateY(0);
    }

    .saved-list {
      margin-top: 6px;
      max-height: 180px;
      overflow-y: auto;
      border-top: 1px solid #18181b;
      padding-top: 6px;
    }

    .saved-title {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .saved-item {
      width: 100%;
      text-align: right;
      padding: 6px 9px;
      margin-bottom: 4px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #d4d4d8;
      font-size: 11px;
      cursor: pointer;
      outline: none;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .saved-item span {
      font-size: 10px;
      opacity: 0.7;
    }

    /* ====== CHAT AREA ====== */

    .chat-wrapper {
      background: #050505;
      border: 1px solid #27272f;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      min-height: 480px;
      overflow: hidden;
    }

    .chat-header {
      padding: 10px 14px;
      border-bottom: 1px solid #18181b;
      background: #000000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .chat-header-title {
      font-weight: 600;
    }

    .chat-header-sub {
      font-size: 11px;
      opacity: 0.7;
    }

    .chat-header-actions {
      display: flex;
      gap: 8px;
    }

    .mini-btn {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: pointer;
    }

    .messages {
      flex: 1;
      padding: 14px;
      overflow-y: auto;
      background: radial-gradient(circle at 0 0, #050505, #000000);
      font-size: 14px;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 80%;
      line-height: 1.7;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg.ai {
      background: #18181b;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .msg.user {
      background: #2563eb;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .typing-indicator {
      font-size: 12px;
      opacity: 0.7;
      margin: 0 4px 4px;
      padding: 0 14px 4px;
      display: none;
    }

    .typing-indicator.visible {
      display: block;
    }

    .export-bar {
      padding: 6px 12px;
      border-top: 1px solid #18181b;
      border-bottom: 1px solid #18181b;
      background: #020617;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }

    .export-bar span {
      opacity: 0.8;
    }

    .export-btn {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: not-allowed;
      opacity: 0.4;
    }

    .export-btn.enabled {
      cursor: pointer;
      opacity: 1;
    }

    .input-area {
      padding: 10px;
      border-top: 1px solid #18181b;
      background: #000000;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-main {
      display: flex;
      flex: 1;
      gap: 8px;
      align-items: center;
    }

    .input-area input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #050505;
      color: #ffffff;
      font-size: 13px;
      outline: none;
    }

    .input-area button.send-btn {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(120deg, #22c1c3, #4b6cff);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
    }

    .input-area .img-btn {
      font-size: 11px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #27272f;
      background: #020617;
      color: #e5e5e5;
      cursor: pointer;
      white-space: nowrap;
    }

    .image-hint {
      font-size: 11px;
      opacity: 0.7;
      flex-basis: 100%;
      margin-top: 4px;
    }

    footer {
      text-align: center;
      padding: 12px;
      font-size: 11px;
      opacity: 0.6;
      border-top: 1px solid #18181b;
    }

    /* ====== TOOL MODAL ====== */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: #050505;
      border-radius: 16px;
      border: 1px solid #27272f;
      max-width: 480px;
      width: 100%;
      padding: 14px 16px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .modal-desc {
      font-size: 11px;
      opacity: 0.75;
      margin-bottom: 8px;
    }

    .modal textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid #27272f;
      background: #020617;
      color: #ffffff;
      font-size: 13px;
      padding: 8px 10px;
      outline: none;
      margin-bottom: 8px;
      direction: rtl;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      font-size: 12px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #27272f;
      color: #e5e5e5;
    }

    .btn-primary {
      background: linear-gradient(120deg, #22c1c3, #4b6cff);
      color: #ffffff;
    }
  </style>
</head>
<body>

<header>
  <h1>Ù…Ø­Ù…ÙˆØ¯ â€“ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ</h1>
  <p>Ø´Ø§Øª Gemini 2.5 Flash Ø¹Ø¨Ø± Ø³ÙŠØ±ÙØ± Ø®Ø§Øµ ÙŠØ¹Ù…Ù„ 24/7</p>
</header>

<main class="layout">

  <!-- ===== SIDEBAR TOOLS ===== -->
  <aside class="sidebar">
    <div>
      <div class="sidebar-title">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</div>
      <div class="sidebar-sub">Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>

      <div class="tool-group-title">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†ÙˆØªØ© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©</div>
      <button class="tool-btn" onclick="openToolModal('summary')">
        ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†ÙˆØªØ© <span>Summarize</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('improve')">
        ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø© <span>Improve</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('new_text')">
        ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø¬Ø¯ÙŠØ¯ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ <span>Generate</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('autocomplete')">
        Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ <span>Continue</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('note_full')">
        Ø¥Ù†Ø´Ø§Ø¡ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© <span>Full note</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('bullet_to_para')">
        ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· â†’ ÙÙ‚Ø±Ø© <span>Bullets â†’ Paragraph</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('ask_about_note')">
        Ø³Ø¤Ø§Ù„ AI Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ÙˆØªØ© <span>Ask note</span>
      </button>

      <div class="tool-group-title" style="margin-top: 12px;">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</div>
      <button class="tool-btn" onclick="openToolModal('planner')">
        Planner AI Ù„Ù„Ù…Ù‡Ø§Ù… <span>Tasks plan</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('health')">
        Health AI Ù„Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ <span>Health</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('pomodoro')">
        Pomodoro AI Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª <span>Focus</span>
      </button>
      <button class="tool-btn" onclick="openToolModal('pdf')">
        ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù PDF Ø¨Ø§Ù„Ù†Øµ <span>PDF text</span>
      </button>
    </div>

    <!-- Saved conversations -->
    <div class="saved-list">
      <div class="saved-title">Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>
      <div id="savedConversations"></div>
    </div>
  </aside>

  <!-- ===== CHAT ===== -->
  <section class="chat-wrapper">
    <div class="chat-header">
      <div>
        <div class="chat-header-title">Ø´Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
        <div class="chat-header-sub">Ù…Ø­Ù…ÙˆØ¯ AI â€“ Ù…ØªØµÙ„ Ø¨Ø³ÙŠØ±ÙØ± atlas-ai</div>
      </div>
      <div class="chat-header-actions">
        <button class="mini-btn" onclick="saveCurrentConversation()">Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        <button class="mini-btn" onclick="clearConversation()">Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
    </div>

    <div id="messages" class="messages"></div>

    <div id="typingIndicator" class="typing-indicator">
      Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙÙƒØ± ÙÙŠ Ø§Ù„Ø±Ø¯...
    </div>

    <div class="export-bar">
      <span>ØªØµØ¯ÙŠØ± Ø¢Ø®Ø± Ø±Ø¯:</span>
      <button id="btnTxt" class="export-btn" onclick="downloadAsTxt()" disabled>TXT</button>
      <button id="btnDoc" class="export-btn" onclick="downloadAsDoc()" disabled>Word</button>
      <button id="btnPdf" class="export-btn" onclick="downloadAsPdf()" disabled>PDF</button>
    </div>

    <div class="input-area">
      <div class="input-main">
        <input id="chatInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." />
        <button id="sendBtn" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
      <button class="img-btn" onclick="triggerImagePicker()">ğŸ“· Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©</button>
      <input id="imageInput" type="file" accept="image/*" style="display:none" />
      <div class="image-hint" id="imageHint"></div>
    </div>
  </section>

</main>

<footer>
  Â© <span id="year"></span> Ù…Ø­Ù…ÙˆØ¯ â€“ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
</footer>

<!-- ===== TOOL MODAL ===== -->
<div id="toolModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-title" id="toolModalTitle">Ø£Ø¯Ø§Ø©</div>
    <div class="modal-desc" id="toolModalDesc"></div>
    <textarea id="toolModalTextarea" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ù‡Ù†Ø§..."></textarea>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeToolModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="sendToolRequest()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø©</button>
    </div>
  </div>
</div>

<script>
  // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =====
  // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ø°Ø§ ØªØºÙŠÙ‘Ø± Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Render
  const API_CHAT  = "https://atlas-ai-hrgs.onrender.com/api/chat";
  const API_IMAGE = "https://atlas-ai-hrgs.onrender.com/api/image_chat";

  const messagesEl  = document.getElementById("messages");
  const inputEl     = document.getElementById("chatInput");
  const sendBtn     = document.getElementById("sendBtn");
  const typingEl    = document.getElementById("typingIndicator");
  const imageInput  = document.getElementById("imageInput");
  const imageHint   = document.getElementById("imageHint");
  const savedListEl = document.getElementById("savedConversations");

  document.getElementById("year").textContent = new Date().getFullYear();

  let lastAiReply = "";
  let currentConversation = [];
  let savedConversations  = [];

  function addMessage(text, sender, addToMemory = true) {
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    if (addToMemory) {
      currentConversation.push({
        sender,
        text,
        ts: Date.now(),
      });
    }

    // Ù„Ùˆ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ù€ AI Ù†Ø®Ø²Ù‘Ù†Ù‡ Ù„Ù„ØªØµØ¯ÙŠØ±
    if (sender === "ai") {
      lastAiReply = text;
      updateExportButtons();
    }
  }

  function showTyping() {
    typingEl.classList.add("visible");
  }

  function hideTyping() {
    typingEl.classList.remove("visible");
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    addMessage(text, "user");
    inputEl.value = "";
    await callTextApi(text);
  }

  async function callTextApi(messageText) {
    try {
      showTyping();

      const res = await fetch(API_CHAT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: messageText }),
      });

      const data = await res.json();
      hideTyping();

      if (data.reply) {
        addMessage(data.reply, "ai");
      } else if (data.text) {
        addMessage(data.text, "ai");
      } else {
        addMessage("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯ Ù„ÙƒÙ† ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡ØªÙ‡.", "ai");
      }
    } catch (err) {
      console.error(err);
      hideTyping();
      addMessage("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.", "ai");
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø£ÙˆÙ„ Ù…Ø±Ø©
  addMessage("Ø£Ù‡Ù„Ø§Ù‹ Ù…Ø­Ù…ÙˆØ¯ ğŸ‘‹\nØ£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ. Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†.", "ai", true);

  // ===== Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙÙŠ localStorage =====
  function loadSavedConversations() {
    try {
      const raw = localStorage.getItem("mahmoud_ai_conversations") || "[]";
      savedConversations = JSON.parse(raw);
    } catch {
      savedConversations = [];
    }
    renderSavedConversations();
  }

  function renderSavedConversations() {
    savedListEl.innerHTML = "";
    if (!savedConversations.length) {
      const span = document.createElement("span");
      span.style.fontSize = "11px";
      span.style.opacity   = "0.6";
      span.textContent     = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.";
      savedListEl.appendChild(span);
      return;
    }
    savedConversations
      .slice()
      .reverse()
      .forEach((conv) => {
        const btn = document.createElement("button");
        btn.className = "saved-item";
        btn.onclick   = () => loadConversation(conv.id);
        const title   = conv.title || "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const date    = new Date(conv.createdAt).toLocaleString("ar-JO");
        btn.innerHTML = `<div>${title}</div><span>${date}</span>`;
        savedListEl.appendChild(btn);
      });
  }

  function saveCurrentConversation() {
    if (!currentConversation.length) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ø­ÙØ¸Ù‡.");
      return;
    }

    const firstUserMsg = currentConversation.find((m) => m.sender === "user");
    const title = firstUserMsg ? firstUserMsg.text.slice(0, 24) + "..." : "Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­ÙÙˆØ¸Ø©";

    const conv = {
      id: Date.now(),
      title,
      createdAt: Date.now(),
      messages: currentConversation,
    };

    savedConversations.push(conv);
    localStorage.setItem("mahmoud_ai_conversations", JSON.stringify(savedConversations));
    renderSavedConversations();
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­.");
  }

  function loadConversation(id) {
    const conv = savedConversations.find((c) => c.id === id);
    if (!conv) return;

    messagesEl.innerHTML   = "";
    currentConversation    = conv.messages.slice();
    lastAiReply            = "";
    currentConversation.forEach((m) => {
      addMessage(m.text, m.sender, false);
      if (m.sender === "ai") {
        lastAiReply = m.text; // Ø¢Ø®Ø± Ø±Ø¯ Ù…Ù† AI
      }
    });
    updateExportButtons();
  }

  function clearConversation() {
    messagesEl.innerHTML = "";
    currentConversation  = [];
    lastAiReply          = "";
    addMessage("Ø¨Ø¯Ø£Ù†Ø§ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© âœ…\nØ§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", "ai", true);
    updateExportButtons();
  }

  loadSavedConversations();
  updateExportButtons();

  // ===== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± =====
  let currentTool = null;

  const TOOL_CONFIG = {
    summary: {
      title: "ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†ÙˆØªØ©",
      desc: "Ø£Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªÙ„Ø®ÙŠØµÙ‡ØŒ ÙˆØ³Ø£Ù‚Ø¯Ù‘Ù… Ù„Ùƒ Ù…Ù„Ø®ØµØ§Ù‹ Ù…Ù†Ø¸Ù‘Ù…Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹.",
    },
    improve: {
      title: "ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©",
      desc: "Ø£Ù„ØµÙ‚ Ø§Ù„Ù†ØµØŒ ÙˆØ³Ø£Ø¹ÙŠØ¯ ØµÙŠØ§ØºØªÙ‡ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ØŒ Ø£ÙˆØ¶Ø­ØŒ ÙˆØ£Ù‚ÙˆÙ‰ Ù„ØºÙˆÙŠØ§Ù‹.",
    },
    new_text: {
      title: "ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø¬Ø¯ÙŠØ¯",
      desc: "Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ (Ù…Ø«Ù„Ø§Ù‹: Ù…Ù‚Ø§Ù„ØŒ Ø±Ø³Ø§Ù„Ø©ØŒ ÙˆØµÙØŒ Ù…Ù†Ø´ÙˆØ±...) ÙˆØ³Ø£ÙƒØªØ¨ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹.",
    },
    autocomplete: {
      title: "Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹",
      desc: "Ø£Ù„ØµÙ‚ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†ØµØŒ ÙˆØ³Ø£ÙƒÙ…Ù„ Ø¹Ù„ÙŠÙƒ Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨.",
    },
    note_full: {
      title: "Ø¥Ù†Ø´Ø§Ø¡ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø©",
      desc: "Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ ÙˆØ³Ø£Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©.",
    },
    bullet_to_para: {
      title: "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø©",
      desc: "Ø£Ù„ØµÙ‚ Ù†Ù‚Ø§Ø·Ùƒ (ÙƒÙ„ Ù†Ù‚Ø·Ø© ÙÙŠ Ø³Ø·Ø±)ØŒ ÙˆØ³Ø£Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø© Ù…ØªØ±Ø§Ø¨Ø·Ø©.",
    },
    ask_about_note: {
      title: "Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ÙˆØªØ©",
      desc: "Ø£Ù„ØµÙ‚ Ø§Ù„Ù†ÙˆØªØ©ØŒ Ø«Ù… Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù†Ù‡Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ù‚Ù„.",
    },
    planner: {
      title: "Planner AI Ù„Ù„Ù…Ù‡Ø§Ù…",
      desc: "Ø§ÙƒØªØ¨ Ù…Ù‡Ø§Ù…Ùƒ Ø£Ùˆ Ø£Ù‡Ø¯Ø§ÙÙƒ Ù„Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŒ ÙˆØ³Ø£Ø±ØªØ¨Ù‡Ø§ Ù„Ùƒ Ø¨Ø®Ø·Ø© Ù…Ù†Ø¸Ù…Ø©.",
    },
    health: {
      title: "Health AI Ù„Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ",
      desc: "Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ù†Ù…Ø· Ø­ÙŠØ§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙˆØ³Ø£Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ Ø±ÙˆØªÙŠÙ† ØµØ­ÙŠ Ø¨Ø³ÙŠØ·.",
    },
    pomodoro: {
      title: "Pomodoro AI",
      desc: "Ø§ÙƒØªØ¨ Ù…Ø§ ØªØ±ÙŠØ¯ Ø¥Ù†Ø¬Ø§Ø²Ù‡ØŒ ÙˆØ³Ø£Ù‚Ø³Ù…Ù‡ Ù„Ùƒ Ø¥Ù„Ù‰ Ø¬Ù„Ø³Ø§Øª ØªØ±ÙƒÙŠØ² (Pomodoro).",
    },
    pdf: {
      title: "ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù PDF Ø¨Ø§Ù„Ù†Øµ",
      desc: "Ø§Ù†Ø³Ø® Ù†ØµØ§Ù‹ Ù…Ù† Ù…Ù„Ù PDF Ø£Ùˆ ÙˆØµÙ Ù…Ø­ØªÙˆØ§Ù‡ØŒ ÙˆØ³Ø£Ø­Ù„Ù‘Ù„Ù‡ Ù„Ùƒ ÙˆØ£Ø³ØªØ®Ø±Ø¬ Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø·.",
    },
  };

  const modalBackdrop  = document.getElementById("toolModalBackdrop");
  const modalTitle     = document.getElementById("toolModalTitle");
  const modalDesc      = document.getElementById("toolModalDesc");
  const modalTextarea  = document.getElementById("toolModalTextarea");

  function openToolModal(toolKey) {
    currentTool = toolKey;
    const cfg   = TOOL_CONFIG[toolKey];
    modalTitle.textContent    = cfg.title;
    modalDesc.textContent     = cfg.desc;
    modalTextarea.value       = "";
    modalBackdrop.classList.add("visible");
  }

  function closeToolModal() {
    modalBackdrop.classList.remove("visible");
    currentTool = null;
  }

  function buildToolPrompt(toolKey, text) {
    switch (toolKey) {
      case "summary":
        return `Ø£Ù„Ø®Ù‘Øµ Ù„Ùƒ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù… Ø¨Ù†Ù‚Ø§Ø· ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©:\n\n${text}`;
      case "improve":
        return `Ø­Ø³Ù‘Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù†Ù‰:\n\n${text}`;
      case "new_text":
        return `Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹ ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨:\n\n${text}`;
      case "autocomplete":
        return `Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ø´Ø§Ø¨Ù‡ ÙˆØ·Ø¨ÙŠØ¹ÙŠ:\n\n${text}`;
      case "note_full":
        return `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ù†ÙˆØªØ© ÙƒØ§Ù…Ù„Ø© ÙˆÙ…Ù‚Ø³Ù…Ø© Ø¨Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©:\n\n${text}`;
      case "bullet_to_para":
        return `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ§Ù„ÙŠØ© (ÙƒÙ„ Ø³Ø·Ø± Ù†Ù‚Ø·Ø©) Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…ØªØ±Ø§Ø¨Ø·Ø©:\n\n${text}`;
      case "ask_about_note":
        return `Ø³Ø£Ø¹Ø·ÙŠÙƒ Ù†ÙˆØªØ© ÙˆØ³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù†Ù‡Ø§. Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ù†ÙˆØªØ©ØŒ Ø«Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…ØªÙŠ [Ø³Ø¤Ø§Ù„].\n\n${text}`;
      case "planner":
        return `Ø£Ù†Øª Planner AI Ù„Ù…Ø­Ù…ÙˆØ¯. Ø£Ù†Ø´Ø¦ Ø®Ø·Ø© Ù…Ù‡Ø§Ù… Ù…Ù†Ø¸Ù…Ø© Ø§Ø³ØªÙ†Ø§Ø¯Ø§Ù‹ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª:\n\n${text}`;
      case "health":
        return `Ø£Ù†Øª Health AI Ù„Ù…Ø­Ù…ÙˆØ¯. Ø§Ù‚ØªØ±Ø­ Ø±ÙˆØªÙŠÙ†Ø§Ù‹ ØµØ­ÙŠØ§Ù‹ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ø¨Ø³Ø·Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØªÙØ§ØµÙŠÙ„:\n\n${text}`;
      case "pomodoro":
        return `Ù‚Ø³Ù‘Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ø¥Ù„Ù‰ Ø¬Ù„Ø³Ø§Øª ØªØ±ÙƒÙŠØ² Ø¨Ù†Ø¸Ø§Ù… Pomodoro (25 Ø¯Ù‚ÙŠÙ‚Ø© ØªØ±ÙƒÙŠØ² + 5 Ø±Ø§Ø­Ø©):\n\n${text}`;
      case "pdf":
        return `Ù‡Ø°Ø§ Ù†Øµ Ù…Ø£Ø®ÙˆØ° Ù…Ù† Ù…Ù„Ù PDF Ø£Ùˆ ÙˆØµÙ Ù…Ø­ØªÙˆØ§Ù‡. Ø­Ù„Ù‘Ù„Ù‡ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø£Ù‡Ù… Ø§Ù„Ø£ÙÙƒØ§Ø± Ù…Ø¹ Ù…Ù„Ø®Øµ:\n\n${text}`;
      default:
        return text;
    }
  }

  async function sendToolRequest() {
    const rawText = modalTextarea.value.trim();
    if (!currentTool || !rawText) return;

    const cfg        = TOOL_CONFIG[currentTool];
    const toolPrompt = buildToolPrompt(currentTool, rawText);

    addMessage(`[${cfg.title}]\n${rawText}`, "user");
    closeToolModal();

    await callTextApi(toolPrompt);
  }

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± =====
  function triggerImagePicker() {
    imageInput.click();
  }

  imageInput.addEventListener("change", async () => {
    const file = imageInput.files[0];
    if (!file) return;

    imageHint.textContent = "ğŸ“· ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©ØŒ ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø±ÙØ¹Ù‡Ø§ ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§...";
    const reader = new FileReader();
    reader.onload = async () => {
      const base64Data = reader.result.split(",")[1];

      // Ù†Ø£Ø®Ø° Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙƒØªÙˆØ¨ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯) ÙƒØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
      const text = inputEl.value.trim();
      inputEl.value = "";

      addMessage(text ? `ğŸ” ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ù†Øµ:\n${text}` : "ğŸ” Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„...", "user");

      await callImageApi(base64Data, text);
      imageHint.textContent = "";
      imageInput.value      = "";
    };
    reader.readAsDataURL(file);
  });

  async function callImageApi(imageBase64, messageText) {
    try {
      showTyping();

      const res = await fetch(API_IMAGE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: messageText || "",
          image: imageBase64,
        }),
      });

      const data = await res.json();
      hideTyping();

      if (data.reply) {
        addMessage(data.reply, "ai");
      } else if (data.text) {
        addMessage(data.text, "ai");
      } else {
        addMessage("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯ Ù„ÙƒÙ† ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡ØªÙ‡.", "ai");
      }
    } catch (err) {
      console.error(err);
      hideTyping();
      addMessage("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.", "ai");
    }
  }

  // ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± =====
  function updateExportButtons() {
    const has = !!(lastAiReply && lastAiReply.trim());
    ["btnTxt", "btnDoc", "btnPdf"].forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (has) {
        el.disabled = false;
        el.classList.add("enabled");
      } else {
        el.disabled = true;
        el.classList.remove("enabled");
      }
    });
  }

  function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href     = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function downloadAsTxt() {
    if (!lastAiReply || !lastAiReply.trim()) return;
    downloadFile("mahmoud_ai_note.txt", lastAiReply, "text/plain;charset=utf-8");
  }

  function downloadAsDoc() {
    if (!lastAiReply || !lastAiReply.trim()) return;
    const rtf = "{\\rtf1\\ansi\n" + lastAiReply.replace(/\n/g, "\\par\n") + "\n}";
    downloadFile("mahmoud_ai_note.doc", rtf, "application/rtf");
  }

  function downloadAsPdf() {
    if (!lastAiReply || !lastAiReply.trim()) return;
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("Ù…ÙƒØªØ¨Ø© PDF ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc       = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });

    const margin    = 40;
    const pageWidth = doc.internal.pageSize.getWidth();
    const maxWidth  = pageWidth - margin * 2;

    const lines = doc.splitTextToSize(lastAiReply, maxWidth);
    doc.text(lines, margin, margin);
    doc.save("mahmoud_ai_note.pdf");
  }
</script>

</body>
</html>
